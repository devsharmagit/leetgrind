generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum GroupVisibility {
  UNLISTED
  PRIVATE
}

model User {
  id          Int     @id @default(autoincrement())
  email       String  @unique
  name        String

  ownedGroups Group[] @relation("GroupOwner")

  createdAt   DateTime @default(now())
}

model Group {
  id          Int     @id @default(autoincrement())
  publicId String @unique @default(cuid())
  name        String
  visibility  GroupVisibility @default(UNLISTED)

  ownerId     Int
  owner       User    @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  members     GroupMember[]
  leaderboardSnapshots LeaderboardSnapshot[]

  createdAt   DateTime @default(now())

  @@index([publicId])
}

model LeetcodeProfile {
  id        Int    @id @default(autoincrement())
  username  String @unique

  groups    GroupMember[]
  stats     DailyStat[]

  createdAt DateTime @default(now())
}

model GroupMember {
  id                Int @id @default(autoincrement())
  groupId           Int
  leetcodeProfileId Int

  group             Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  leetcodeProfile   LeetcodeProfile @relation(fields: [leetcodeProfileId], references: [id], onDelete: Cascade)

  @@unique([groupId, leetcodeProfileId])
  @@index([groupId])
}

model DailyStat {
  id                Int @id @default(autoincrement())
  leetcodeProfileId Int
  date              DateTime @db.Date

  totalSolved       Int
  easySolved        Int @default(0)
  mediumSolved      Int @default(0)
  hardSolved        Int @default(0)
  ranking           Int @default(0)
  contestRating     Int @default(0)
  rankingPoints     Int

  leetcodeProfile   LeetcodeProfile @relation(fields: [leetcodeProfileId], references: [id], onDelete: Cascade)

  @@unique([leetcodeProfileId, date])
  @@index([date])
  @@index([leetcodeProfileId])
}

model LeaderboardSnapshot {
  id           Int      @id @default(autoincrement())
  groupId      Int
  date         DateTime @db.Date

  snapshotData Json
  topGainers   Json?

  createdAt    DateTime @default(now())

  group        Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, date])
  @@index([groupId])
  @@index([date])
}